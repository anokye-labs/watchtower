# CI/CD Workflows

This document describes the Continuous Integration and Continuous Deployment workflows for the WatchTower project.

## PR Build and Test Validation

**File**: `.github/workflows/pr-validation.yml`

### Overview

The PR validation workflow runs on every pull request to ensure code quality and test coverage before merging to the main branch.

### Performance Optimizations

The workflow implements several caching strategies to speed up builds and reduce runner minutes:

1. **NuGet Package Caching**: Uses `actions/cache@v4` to cache the NuGet global packages folder (`~/.nuget/packages`). The cache key is based on the hash of all `.csproj` and `.slnx` files, ensuring the cache is invalidated when dependencies change.

2. **setup-dotnet Built-in Caching**: Enables the `cache: true` parameter in `actions/setup-dotnet@v4` to cache NuGet packages based on `packages.lock.json` files. This provides an additional layer of caching specific to the .NET SDK tooling.

These optimizations significantly reduce build times by:
- Avoiding redundant package downloads on subsequent runs
- Reusing cached packages when dependencies haven't changed
- Falling back to partial cache matches when exact matches aren't found

**Cache Invalidation**: The cache is automatically invalidated when project files (`.csproj`, `.slnx`) change, ensuring fresh packages are downloaded when dependencies are updated.

### Triggers

- Pull request events: `opened`, `synchronize`, `reopened`
- Target branch: `main`
- Manual trigger: `workflow_dispatch` with configurable coverage threshold

### Jobs

#### 1. Build and Test

Runs on Windows to build and test the application:

- **windows-latest** (Windows)

**Steps:**
1. Checkout code
2. Setup .NET 10 SDK
3. Restore dependencies using `dotnet restore WatchTower.slnx`
4. Build solution in Release mode with `dotnet build`
5. Run tests with code coverage collection using `coverlet.collector`
6. Upload coverage artifacts
7. Upload test results as artifacts

#### 2. Coverage Report

Runs on Windows after successful build/test completion.

**Steps:**
1. Download coverage results from build job
2. Install ReportGenerator tool
3. Generate HTML coverage report focused on Services and ViewModels
4. Upload HTML coverage report as artifact
5. Check if Services/ViewModels files changed in PR
6. Parse Cobertura XML and calculate coverage percentages
7. Post coverage summary as PR comment
8. Fail workflow if coverage threshold not met

### Coverage Threshold

The workflow enforces **80% code coverage** for `Services/` and `ViewModels/` directories combined.

**Behavior:**
- If Services or ViewModels files are modified in the PR, the 80% threshold is **enforced**
- If no Services/ViewModels files are modified, the coverage report is **informational only**
- The threshold can be customized via workflow_dispatch input (default: 80%)

### Coverage Report Format

The coverage report is posted as a PR comment with the following information:

| Category | Coverage | Lines Covered | Total Lines |
|----------|----------|---------------|-------------|
| Services | X.XX% | ### | ### |
| ViewModels | X.XX% | ### | ### |
| Combined Services/ViewModels | **X.XX%** | ### | ### |
| Overall Project | X.XX% | ### | ### |

**Threshold Status:**
- ✅ PASSED - Coverage meets or exceeds the threshold
- ❌ FAILED - Coverage is below the threshold (workflow fails)
- ℹ️ INFORMATIONAL - No relevant files changed (workflow passes)

### Artifacts

The workflow uploads the following artifacts:

1. **coverage-results** - Raw Cobertura XML coverage files (30-day retention)
2. **coverage-html-report** - HTML coverage report generated by ReportGenerator (30-day retention)
3. **test-results** - Test results (30-day retention)

### Testing the Workflow

To test the workflow without creating a PR:

1. Navigate to Actions tab in GitHub
2. Select "PR Build and Test Validation" workflow
3. Click "Run workflow"
4. Optionally customize the coverage threshold
5. Click "Run workflow" button

### Local Testing

To test coverage locally:

```bash
# Restore and build
dotnet restore WatchTower.slnx
dotnet build WatchTower.slnx -c Release

# Run tests with coverage
dotnet test WatchTower.slnx --no-build -c Release --collect:"XPlat Code Coverage" --results-directory ./coverage

# Find and view coverage report (PowerShell)
Get-ChildItem -Recurse -Filter "coverage.cobertura.xml" -Path ./coverage
```

To generate HTML reports locally:

```powershell
# Install ReportGenerator
dotnet tool install -g dotnet-reportgenerator-globaltool

# Generate report
reportgenerator `
  -reports:coverage/**/coverage.cobertura.xml `
  -targetdir:coverage-report `
  -reporttypes:"Html;Cobertura"

# Open report in browser
start coverage-report/index.html
```

## Future Workflows

### Planned Workflows

- **Code Formatting Check** - Validates code follows .editorconfig standards
- **Dependabot Configuration** - Automated dependency updates
- **CI Integration with Project Management** - Links CI status to project board

### Branch Protection

Once all workflows are tested and stable, enable branch protection rules on `main`:

1. Navigate to Settings > Branches
2. Add rule for `main` branch
3. Require status checks to pass:
   - Build and Test
   - Coverage Report
4. Require PR reviews before merging
5. Dismiss stale PR approvals when new commits are pushed

## Caching Best Practices

### NuGet Package Caching

All workflows use two complementary caching strategies:

1. **Manual Cache Step** (`actions/cache@v4`):
   - Caches `~/.nuget/packages` directory
   - Cache key: `${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.slnx') }}`
   - Restore key: `${{ runner.os }}-nuget-` (partial match fallback)
   - Invalidates when any project file changes

2. **setup-dotnet Built-in Caching**:
   - Enabled with `cache: true` parameter
   - Uses `cache-dependency-path: '**/packages.lock.json'` for lock file-based caching
   - Provides additional layer of caching specific to .NET tooling

### Cache Performance

**Benefits:**
- Reduces build time by 30-50% on cache hits
- Saves GitHub Actions runner minutes
- Speeds up feedback cycle for contributors
- Reduces network bandwidth usage

**Cache Behavior:**
- **Cache Hit**: Packages are restored from cache instantly
- **Partial Hit**: Some packages restored from cache, others downloaded
- **Cache Miss**: All packages downloaded, then cached for future runs

### Monitoring Cache Effectiveness

Check cache performance in workflow logs:

```
Cache NuGet packages
  Cache restored successfully from key: Windows-nuget-abc123...
```

Or if cache miss:

```
Cache NuGet packages
  Cache not found for input keys: Windows-nuget-abc123...
```

### Cache Maintenance

GitHub Actions automatically manages cache lifecycle:
- Maximum cache size: 10 GB per repository
- Unused caches are evicted after 7 days
- Older caches are evicted when size limit is reached

No manual maintenance required.

## Troubleshooting

### Coverage File Not Found

If the coverage report job fails with "Coverage file not found":

1. Check that tests are running successfully in the build-and-test job
2. Verify the coverage artifact was uploaded from the Windows runner
3. Check that `coverlet.collector` is in WatchTower.Tests.csproj dependencies

### Coverage Parsing Errors

If coverage parsing fails:

1. Download the coverage-results artifact
2. Verify the XML structure matches Cobertura format
3. Check that Services and ViewModels classes are present in the coverage report

### Workflow Syntax Errors

Validate YAML syntax locally:

```bash
# Using Python
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/pr-validation.yml'))"

# Using yamllint (if installed)
yamllint .github/workflows/pr-validation.yml
```

## References

- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [Coverlet Documentation](https://github.com/coverlet-coverage/coverlet)
- [ReportGenerator Documentation](https://github.com/danielpalme/ReportGenerator)
- [Cobertura Format Specification](https://cobertura.github.io/cobertura/)
