# Agent Configuration
# How agents interact with the continuous flow system
# 
# This file is read by agents (Claude, Copilot) to understand
# how to select work, when to request human input, and how to
# transition issue states.

agent_flow:
  project:
    owner: "anokye-labs"
    repo: "watchtower"
    board_url: "https://github.com/orgs/anokye-labs/projects/1"  # Update with actual project number
    
  work_selection:
    # Agents should query this view to find work
    primary_view: "Work Queue"
    
    # Only pick items matching ALL these criteria
    filters:
      status: ["Ready"]  # Only Ready items
      agent_type:  # Agent types this agent can work on
        - "Copilot"
        - "Claude-Opus"
        - "Any Agent"
      dependencies: ["None"]  # No blocking dependencies (or all deps in Done)
    
    # Pick in this order: highest priority first, then lowest complexity
    sort:
      - "priority DESC"   # P0 first
      - "complexity ASC"  # Then lowest complexity
    
    # Maximum items to work on simultaneously
    max_concurrent: 1
    
  quality_gates:
    # Rules that trigger additional requirements
    
    # Complexity ≥5 requires tests
    - name: "requires_testing"
      condition: "complexity >= 5"
      require_label: "requires:testing"
      action: "warn_on_pr_if_no_tests"
      message: "This item has Complexity ≥5. Tests are required."
    
    # Services/ViewModels require cross-platform validation
    - name: "cross_platform"
      condition: "component in ['Services', 'ViewModels']"
      action: "ci_matrix"
      platforms: ["win-x64", "osx-x64", "linux-x64"]
    
    # Tech Design Needed requires human review
    - name: "human_review"
      condition: "has_label('Tech Design Needed')"
      action: "request_review"
      reviewer: "@hoopsomuah"
      message: "This item has Tech Design Needed label. Human review required before work begins."
    
    # requires:human-decision means STOP and assign to human
    - name: "human_decision_required"
      condition: "has_label('requires:human-decision')"
      action: "stop_and_assign"
      assignee: "@hoopsomuah"
      message: "This item requires a human decision. Do NOT proceed."
      
  state_transitions:
    # How automation moves items through the flow
    
    on_pr_opened:
      set_status: "In progress"
      add_label: "agent:in-progress"
      update_last_activity: true
      populate_pr_link: true
      remove_label: "agent:ready"
      
    on_checks_passed_and_ready_for_review:
      set_status: "In review"
      remove_label: "agent:in-progress"
      remove_label: "needs-fix"
      
    on_checks_failed:
      add_label: "needs-fix"
      comment: "Checks failed. Please review the CI output and fix the issues."
      
    on_pr_merged:
      set_status: "Done"
      remove_label: "agent:in-progress"
      close_issue: true
      
  blocked_handling:
    # What to do when items become blocked
    
    assignee: "hoopsomuah"  # Assign blocked items to this user
    stale_threshold_days: 5
    
    on_stale:
      set_status: "Blocked"
      add_label: "stale"
      assign_to: "hoopsomuah"
      comment: |
        ⚠️ **Blocked: No activity for 5 days**
        
        This issue has been in "In Progress" for more than 5 days without activity.
        
        Please:
        1. Check the Dependencies field for blockers
        2. Update status if blocked externally
        3. Or continue work if still active
        
        Assigning to @hoopsomuah for review.

  agent_rules:
    # Additional rules for agent behavior
    
    # Before starting any task, verify:
    pre_work_checks:
      - "Verify Dependencies field - all listed issues must be in Done"
      - "Check for requires:human-decision label - if present, do NOT proceed"
      - "Check for Tech Design Needed label - if present, verify design is approved"
      
    # When encountering blockers:
    on_blocker:
      - "Set Status to Blocked"
      - "Update Dependencies field with blocker issue numbers"
      - "Add comment explaining the blocker"
      - "Assign to @hoopsomuah"
      
    # When completing work:
    on_complete:
      - "Ensure all acceptance criteria are met"
      - "Run dotnet build and dotnet test"
      - "Create PR with 'Closes #issue-number' in body"
      - "Request review if Complexity >= 5"
