name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
  workflow_dispatch:  # Manual trigger for testing

permissions:
  contents: read  # Checkout code only

jobs:
  build-and-test:
    name: Build and Test
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET 10 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'
      
      - name: Restore dependencies
        run: dotnet restore WatchTower.slnx
      
      - name: Build solution
        run: dotnet build WatchTower.slnx --no-restore -c Release
      
      - name: Run tests
        run: dotnet test WatchTower.slnx --no-build -c Release --collect:"XPlat Code Coverage" --logger trx --results-directory TestResults
      
      - name: Publish Windows build
        run: dotnet publish WatchTower/WatchTower.csproj --no-build -c Release -r win-x64 --self-contained true -o publish/win-x64
      
      - name: Upload test results and coverage
        if: always()  # Upload even if tests fail
        uses: actions/upload-artifact@v4
        with:
          name: test-results-windows
          path: TestResults/**/*
          retention-days: 7
      
      - name: Upload Windows build artifact
        uses: actions/upload-artifact@v4
        with:
          name: watchtower-win-x64-pr${{ github.event.pull_request.number || github.run_number }}
          path: publish/win-x64/*
          retention-days: 7
