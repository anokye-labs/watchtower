name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]
  workflow_dispatch:  # Manual trigger for testing

permissions:
  contents: read  # Checkout code only

jobs:
  build-and-test:
    name: Build and Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET 10 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          cache: true
      
      - name: Restore dependencies
        run: dotnet restore WatchTower.slnx
      
      - name: Build solution
        run: dotnet build WatchTower.slnx --no-restore -c Release
      
      - name: Run tests
        run: dotnet test WatchTower.slnx --no-build -c Release --collect:"XPlat Code Coverage" --logger trx --results-directory TestResults
      
      - name: Upload test results and coverage
        if: always()  # Upload even if tests fail
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}
          path: TestResults/**/*
          retention-days: 7
