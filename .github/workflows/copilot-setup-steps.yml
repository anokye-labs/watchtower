name: "Copilot Setup Steps"

# This workflow configures the development environment for GitHub Copilot coding agent.
# It runs automatically when the file changes for validation, and before Copilot starts working.
# See: https://docs.github.com/en/copilot/how-tos/use-copilot-agents/coding-agent/customize-the-agent-environment

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  # The job MUST be called `copilot-setup-steps` or it will not be picked up by Copilot.
  copilot-setup-steps:
    runs-on: ubuntu-latest
    timeout-minutes: 59

    # Set the permissions to the lowest permissions possible needed for your steps.
    # Copilot will be given its own token for its operations.
    permissions:
      contents: read

    steps:
      # Step 1: Checkout repository
      - name: Checkout code
        uses: actions/checkout@v5
        
      # Step 2: Setup .NET 10 SDK
      - name: Setup .NET 10 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'
          
      # Step 3: Verify .NET installation
      - name: Verify .NET installation
        run: |
          dotnet --version
          dotnet --info
          
      # Step 4: Install PowerShell on Ubuntu
      - name: Install PowerShell
        run: |
          # Install PowerShell on Ubuntu
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https software-properties-common
          source /etc/os-release
          wget -q https://packages.microsoft.com/config/ubuntu/$VERSION_ID/packages-microsoft-prod.deb
          sudo dpkg -i packages-microsoft-prod.deb
          rm packages-microsoft-prod.deb
          sudo apt-get update
          sudo apt-get install -y powershell
        
      # Step 5: Verify FAL_KEY environment variable
      # Note: FAL_KEY must be configured in the 'copilot' environment as a secret
      # See: https://docs.github.com/en/copilot/how-tos/use-copilot-agents/coding-agent/customize-the-agent-environment#setting-environment-variables-in-copilots-environment
      - name: Check FAL_KEY configuration
        run: |
          if [ -z "$FAL_KEY" ]; then
            echo "‚ö†Ô∏è FAL_KEY environment variable is not set"
            echo "Configure FAL_KEY as a secret in the 'copilot' environment"
            echo "FAL_KEY is required for AI-powered features"
          else
            echo "‚úÖ FAL_KEY is configured"
          fi
        env:
          FAL_KEY: ${{ secrets.FAL_KEY }}
          
      # Step 6: Restore NuGet dependencies
      - name: Restore dependencies
        run: dotnet restore WatchTower.slnx
        
      # Step 7: Build the solution
      - name: Build solution
        run: dotnet build WatchTower.slnx --no-restore -c Debug
        
      # Step 8: Run tests
      - name: Run tests
        run: dotnet test WatchTower.slnx --no-build -c Debug --verbosity normal
        
      # Step 9: Display setup summary
      - name: Setup summary
        run: |
          echo "================================"
          echo "Development Environment Summary"
          echo "================================"
          echo ""
          echo "‚úÖ .NET 10 SDK: $(dotnet --version)"
          echo "‚úÖ PowerShell: $(pwsh --version)"
          echo "‚úÖ Dependencies: Restored"
          echo "‚úÖ Build: Successful"
          echo "‚úÖ Tests: Passed"
          echo ""
          echo "üìù Copilot coding agent environment is ready"
          echo "   - WatchTower is a Windows-native Avalonia application"
          echo "   - Build and test run on Linux; runtime is win-x64"
